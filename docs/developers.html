<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Developer notes – py-rocket-base</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./related.html" rel="next">
<link href="./r-config.html" rel="prev">
<link href="./assets/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1c72828a604d1ca8431045bd307be2a9.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-ec14e8678c2c066486278521a71c3cb8.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./developers.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Developer notes</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="https://raw.githubusercontent.com/nmfs-opensci/assets/main/logo/nmfs-opensci-logo3.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">py-rocket-base</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://nmfs-opensci.github.io" title="NMFS Open Science" class="quarto-navigation-tool px-1" aria-label="NMFS Open Science"><i class="bi bi-globe"></i></a>
    <a href="https://github.com/nmfs-opensci/py-rocket-base" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./customizing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Using py-rocket-base</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./configuration_files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Customization scripts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./desktop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Desktop</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./publishing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Publishing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./jupyter-config.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Customizing Jupyter</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example_children.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Example child images</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-config.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R in Jupyter Lab and Python in RStudio</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./developers.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Developer notes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./related.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Related Docker Stacks</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#design" id="toc-design" class="nav-link active" data-scroll-target="#design"><span class="header-section-number">9.1</span> Design</a></li>
  <li><a href="#documentation" id="toc-documentation" class="nav-link" data-scroll-target="#documentation"><span class="header-section-number">9.2</span> Documentation</a></li>
  <li><a href="#building-the-images" id="toc-building-the-images" class="nav-link" data-scroll-target="#building-the-images"><span class="header-section-number">9.3</span> Building the images</a></li>
  <li><a href="#base-image" id="toc-base-image" class="nav-link" data-scroll-target="#base-image"><span class="header-section-number">9.4</span> base-image</a></li>
  <li><a href="#py-rocket-base" id="toc-py-rocket-base" class="nav-link" data-scroll-target="#py-rocket-base"><span class="header-section-number">9.5</span> py-rocket-base</a></li>
  <li><a href="#install-rocker.sh" id="toc-install-rocker.sh" class="nav-link" data-scroll-target="#install-rocker.sh"><span class="header-section-number">9.6</span> install-rocker.sh</a></li>
  <li><a href="#start" id="toc-start" class="nav-link" data-scroll-target="#start"><span class="header-section-number">9.7</span> start</a></li>
  <li><a href="#setup-desktop.sh" id="toc-setup-desktop.sh" class="nav-link" data-scroll-target="#setup-desktop.sh"><span class="header-section-number">9.8</span> setup-desktop.sh</a></li>
  <li><a href="#notes-on-the-jupyter-lab-environment" id="toc-notes-on-the-jupyter-lab-environment" class="nav-link" data-scroll-target="#notes-on-the-jupyter-lab-environment"><span class="header-section-number">9.9</span> Notes on the Jupyter Lab environment</a>
  <ul class="collapse">
  <li><a href="#terminal-in-jupyter-lab" id="toc-terminal-in-jupyter-lab" class="nav-link" data-scroll-target="#terminal-in-jupyter-lab"><span class="header-section-number">9.9.1</span> Terminal in Jupyter Lab</a></li>
  </ul></li>
  <li><a href="#notes-on-r-in-the-rstudio-or-jupyter-lab-environment" id="toc-notes-on-r-in-the-rstudio-or-jupyter-lab-environment" class="nav-link" data-scroll-target="#notes-on-r-in-the-rstudio-or-jupyter-lab-environment"><span class="header-section-number">9.10</span> Notes on R in the RStudio or Jupyter Lab environment</a>
  <ul class="collapse">
  <li><a href="#environmental-variables" id="toc-environmental-variables" class="nav-link" data-scroll-target="#environmental-variables"><span class="header-section-number">9.10.1</span> Environmental variables</a></li>
  <li><a href="#terminal-in-rstudio" id="toc-terminal-in-rstudio" class="nav-link" data-scroll-target="#terminal-in-rstudio"><span class="header-section-number">9.10.2</span> Terminal in RStudio</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/nmfs-opensci/py-rocket-base/edit/main/developers.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nmfs-opensci/py-rocket-base/blob/main/developers.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/nmfs-opensci/py-rocket-base/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Developer notes</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="design" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="design"><span class="header-section-number">9.1</span> Design</h2>
<p>py-rocket-base is inspired by <a href="https://github.com/jupyterhub/repo2docker">repo2docker</a> and the <a href="https://pangeo-docker-images.readthedocs.io/en/latest/">Pangeo Docker stack</a> design. py-rocker-base is built the Pangeo base Docker file (with <code>ONBUILD</code> commands stripped out) and that Docker file make the choices regarding the environment design—things like how the conda environment is set-up and the base directory structure and permissions.</p>
<p>The Pangeo Docker stack does not use repo2docker, but mimics repo2docker’s environment design. The Pangeo base-image behaves similar to repo2docker in that using the base-image in the <code>FROM</code> line of a Dockerfile causes the build to look for files with the same names as repo2docker’s <a href="https://repo2docker.readthedocs.io/en/latest/config_files.html">configuration files</a> and then do the proper action with those files. This means that routine users do not need to know how to write Dockerfile code in order to extend the image with new packages or applications. py-rocker-base Docker image uses this Pangeo base-image design. It is based on <code>ONBUILD</code> commands in the Dockerfile that trigger actions only when the image is used in the <code>FROM</code> line of another Dockerfile.</p>
<p>py-rocket-base does not include this <code>ONBUILD</code> behavior. Instead it follows the <a href="https://github.com/rocker-org/rocker-versioned2">rocker docker stack</a> design and provides helper scripts for building on the base image. py-rocket-base a directory called <code>\pyrocket_scripts</code>that will help you do common tasks for scientific docker images.These scripts are not required. If users are familiar with writing Docker files, they can write their own code. The use of helper scripts was used after feedback that the Pangeo ONBUILD behavior makes it harder to customize images that need very specific structure or order of operations.</p>
<p><em>There are many ways to install R and RStudio into an image designed for JupyterHubs</em> The objective of py-rocker-base is not to install R and RStudio, per se, and there are other leaner and faster ways to install R/RStudio if that is your goal<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. The objective of py-rocket-base is to create an JupyterHub image such when you use R in the Jupyter Hub (whether in RStudio, Jupyter Lab, or VSCode), you enter an environment that is the same as if you had used a Rocker image. If you are in the JupyterLab UI, the environment is the same as it you had used repo2docker (or Pangeo base-image) to create the environment.</p>
<aside id="footnotes" class="footnotes footnotes-end-of-block" role="doc-footnote">
<ol>
<li id="fn1"><p>See for example <a href="https://github.com/boettiger-lab/repo2docker-r">repo2docker-r</a> and <a href="https://github.com/binder-examples/r-conda">conda-r</a> in <a href="https://github.com/binder-examples">binder-examples</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>
</section>
<section id="documentation" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="documentation"><span class="header-section-number">9.2</span> Documentation</h2>
<p>To build the documentation book, clone repo and then</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cd book</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>quarto render .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Set GitHub Pages to docs folder.</p>
</section>
<section id="building-the-images" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="building-the-images"><span class="header-section-number">9.3</span> Building the images</h2>
<p>The <code>.github/workflows/build.yaml</code> is a GitHub Action to build the image. The GitHub Action builds the image and the URL will look like one of these</p>
<pre><code>ghcr.io/nmfs-opensci/repo-name/image-name:latest
ghcr.io/nmfs-opensci/image-name:latest</code></pre>
<p>For example, for this repo the image is <code>ghcr.io/nmfs-opensci/py-rocket-base:latest</code>.</p>
</section>
<section id="base-image" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="base-image"><span class="header-section-number">9.4</span> base-image</h2>
<p>In the directory, <code>base-image</code> is the Pangeo base-image Dockerfile minus the ONBUILD statements. Thus the base-image for py-rocket-base is the same as Pangeo base-image but doesn’t have the behavior of automatically processing files like <code>environment.yml</code> in child images (that use the base image in the <code>FROM</code> line).</p>
<p>py-rocket-base uses base-image and adds on the pangeo-notebook metapackage which add the basic JupyterHub and JupyterLab packages. py-rocket-base then adds on R/RStudio, more conda packages and Desktop via install scripts.</p>
</section>
<section id="py-rocket-base" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="py-rocket-base"><span class="header-section-number">9.5</span> py-rocket-base</h2>
<p>The <a href="https://github.com/nmfs-opensci/py-rocket-base/blob/main/Dockerfile">Dockerfile</a> does the following in order:</p>
<ul>
<li>Move files into <code>/srv/repo</code></li>
<li>Move py-rocket scripts into <code>/pyrocket_scripts</code> and rocker scripts into <code>/rocker_scripts</code></li>
<li>Install conda packages with the pangeo-notebook metapackage as the main set of packages plus the extra server packages</li>
<li>Install R and RStudio plus the verse set of packages with the rocker scripts via <code>pyrocket_scripts/install_rocker.sh</code></li>
<li>Set up the R kernel to point to the rocker installed R and fix a few things re reticulate and R in VSCode (happens in <code>pyrocket_scripts/install_rocker.sh</code>).</li>
<li>Set up the Desktop environment and ensure that applications go into <code>/etc/xdg/userconfig</code> instead of <code>$HOME</code>.</li>
<li>Move the start script to <code>/srv/start</code>.</li>
</ul>
<p>The pieces of the Dockerfile are explained below. Click on the number next to code to read about what that code block does.</p>
<div class="sourceCode" id="annotated-cell-3"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>FROM ghcr.io<span class="sc">/</span>nmfs<span class="sc">-</span>opensci<span class="sc">/</span>py<span class="sc">-</span>rocket<span class="sc">-</span>base<span class="sc">/</span>base<span class="sc">-</span>image<span class="sc">:</span>latest</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>USER root</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define environment variables</span></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># DISPLAY Tell applications where to open desktop apps - this allows notebooks to pop open GUIs</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-7" class="code-annotation-target"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>ENV REPO_DIR<span class="ot">=</span><span class="st">"/srv/repo"</span> \</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>    DISPLAY<span class="ot">=</span><span class="st">":1.0"</span> \</span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>    R_VERSION<span class="ot">=</span><span class="st">"4.4.1"</span></span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add NB_USER to staff group (required for rocker script)</span></span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the staff group exists first</span></span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a>RUN groupadd <span class="sc">-</span>f staff <span class="sc">&amp;&amp;</span> usermod <span class="sc">-</span>a <span class="sc">-</span>G staff <span class="st">"${NB_USER}"</span></span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy files into REPO_DIR and make sure staff group can edit (use staff for rocker)</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3">3</button><span id="annotated-cell-3-16" class="code-annotation-target"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>COPY <span class="sc">--</span>chown<span class="ot">=</span><span class="er">$</span>{NB_USER}<span class="sc">:</span><span class="er">$</span>{NB_USER} . <span class="sc">$</span>{REPO_DIR}</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>RUN chgrp <span class="sc">-</span>R staff <span class="sc">$</span>{REPO_DIR} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>    chmod <span class="sc">-</span>R g<span class="sc">+</span>rwx <span class="sc">$</span>{REPO_DIR} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a>    rm <span class="sc">-</span>rf <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>book <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>docs</span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy scripts to /pyrocket_scripts and set permissions</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4">4</button><span id="annotated-cell-3-22" class="code-annotation-target"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">/</span>pyrocket_scripts <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-23"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a>    cp <span class="sc">-</span>r <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>scripts<span class="sc">/</span><span class="er">*</span> <span class="er">/</span>pyrocket_scripts<span class="sc">/</span> <span class="er">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-24"><a href="#annotated-cell-3-24" aria-hidden="true" tabindex="-1"></a>    chown <span class="sc">-</span>R root<span class="sc">:</span>staff <span class="sc">/</span>pyrocket_scripts <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-25"><a href="#annotated-cell-3-25" aria-hidden="true" tabindex="-1"></a>    chmod <span class="sc">-</span>R <span class="dv">775</span> <span class="sc">/</span>pyrocket_scripts</span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Install conda packages (will switch to NB_USER in script)</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="5">5</button><span id="annotated-cell-3-28" class="code-annotation-target"><a href="#annotated-cell-3-28" aria-hidden="true" tabindex="-1"></a>RUN <span class="sc">/</span>pyrocket_scripts<span class="sc">/</span>install<span class="sc">-</span>conda<span class="sc">-</span>packages.sh <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>environment.yml</span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Install R, RStudio via Rocker scripts. Requires the prefix for a rocker Dockerfile</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="6">6</button><span id="annotated-cell-3-31" class="code-annotation-target"><a href="#annotated-cell-3-31" aria-hidden="true" tabindex="-1"></a>RUN <span class="sc">/</span>pyrocket_scripts<span class="sc">/</span>install<span class="sc">-</span>rocker.sh <span class="st">"verse_${R_VERSION}"</span></span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extra apt packages</span></span>
<span id="annotated-cell-3-34"><a href="#annotated-cell-3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Install linux packages after R installation since the R install scripts get rid of packages</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="7">7</button><span id="annotated-cell-3-35" class="code-annotation-target"><a href="#annotated-cell-3-35" aria-hidden="true" tabindex="-1"></a>RUN <span class="sc">/</span>pyrocket_scripts<span class="sc">/</span>install<span class="sc">-</span>apt<span class="sc">-</span>packages.sh <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>apt.txt</span>
<span id="annotated-cell-3-36"><a href="#annotated-cell-3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-37"><a href="#annotated-cell-3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Install some basic VS Code extensions</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="8">8</button><span id="annotated-cell-3-38" class="code-annotation-target"><a href="#annotated-cell-3-38" aria-hidden="true" tabindex="-1"></a>RUN <span class="sc">/</span>pyrocket_scripts<span class="sc">/</span>install<span class="sc">-</span>vscode<span class="sc">-</span>extensions.sh <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>vscode<span class="sc">-</span>extensions.txt</span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-enable man pages disabled in Ubuntu 18 minimal image</span></span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41" aria-hidden="true" tabindex="-1"></a><span class="co"># https://wiki.ubuntu.com/Minimal</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="9">9</button><span id="annotated-cell-3-42" class="code-annotation-target"><a href="#annotated-cell-3-42" aria-hidden="true" tabindex="-1"></a>RUN yes <span class="sc">|</span> unminimize</span>
<span id="annotated-cell-3-43"><a href="#annotated-cell-3-43" aria-hidden="true" tabindex="-1"></a>ENV MANPATH<span class="ot">=</span><span class="st">"${NB_PYTHON_PREFIX}/share/man:${MANPATH}"</span></span>
<span id="annotated-cell-3-44"><a href="#annotated-cell-3-44" aria-hidden="true" tabindex="-1"></a>RUN mandb</span>
<span id="annotated-cell-3-45"><a href="#annotated-cell-3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-46"><a href="#annotated-cell-3-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add custom Jupyter server configurations</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="10">10</button><span id="annotated-cell-3-47" class="code-annotation-target"><a href="#annotated-cell-3-47" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">$</span>{NB_PYTHON_PREFIX}<span class="sc">/</span>etc<span class="sc">/</span>jupyter<span class="sc">/</span>jupyter_server_config.d<span class="sc">/</span> <span class="er">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-48"><a href="#annotated-cell-3-48" aria-hidden="true" tabindex="-1"></a>    mkdir <span class="sc">-</span>p <span class="sc">$</span>{NB_PYTHON_PREFIX}<span class="sc">/</span>etc<span class="sc">/</span>jupyter<span class="sc">/</span>jupyter_notebook_config.d<span class="sc">/</span> <span class="er">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-49"><a href="#annotated-cell-3-49" aria-hidden="true" tabindex="-1"></a>    cp <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>custom_jupyter_server_config.json  <span class="sc">$</span>{NB_PYTHON_PREFIX}<span class="sc">/</span>etc<span class="sc">/</span>jupyter<span class="sc">/</span>jupyter_server_config.d<span class="sc">/</span> <span class="er">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-50"><a href="#annotated-cell-3-50" aria-hidden="true" tabindex="-1"></a>    cp <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>custom_jupyter_server_config.json <span class="sc">$</span>{NB_PYTHON_PREFIX}<span class="sc">/</span>etc<span class="sc">/</span>jupyter<span class="sc">/</span>jupyter_notebook_config.d<span class="sc">/</span></span>
<span id="annotated-cell-3-51"><a href="#annotated-cell-3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-52"><a href="#annotated-cell-3-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the defaults for Desktop. </span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="11">11</button><span id="annotated-cell-3-53" class="code-annotation-target"><a href="#annotated-cell-3-53" aria-hidden="true" tabindex="-1"></a>ENV XDG_CONFIG_HOME<span class="ot">=</span><span class="er">/</span>etc<span class="sc">/</span>xdg<span class="sc">/</span>userconfig</span>
<span id="annotated-cell-3-54"><a href="#annotated-cell-3-54" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">$</span>{XDG_CONFIG_HOME} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-55"><a href="#annotated-cell-3-55" aria-hidden="true" tabindex="-1"></a>    chown <span class="sc">-</span>R <span class="sc">$</span>{NB_USER}<span class="sc">:</span><span class="er">$</span>{NB_USER} <span class="sc">$</span>{XDG_CONFIG_HOME} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-56"><a href="#annotated-cell-3-56" aria-hidden="true" tabindex="-1"></a>    chmod <span class="sc">-</span>R u<span class="sc">+</span>rwx,g<span class="sc">+</span>rwX,o<span class="sc">+</span>rX <span class="sc">$</span>{XDG_CONFIG_HOME} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-57"><a href="#annotated-cell-3-57" aria-hidden="true" tabindex="-1"></a>    mv <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>user<span class="sc">-</span>dirs.dirs <span class="sc">$</span>{XDG_CONFIG_HOME} <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-58"><a href="#annotated-cell-3-58" aria-hidden="true" tabindex="-1"></a>    chmod <span class="sc">+</span>x <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>scripts<span class="sc">/</span>setup<span class="sc">-</span>desktop.sh <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-3-59"><a href="#annotated-cell-3-59" aria-hidden="true" tabindex="-1"></a>    <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>scripts<span class="sc">/</span>setup<span class="sc">-</span>desktop.sh</span>
<span id="annotated-cell-3-60"><a href="#annotated-cell-3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-61"><a href="#annotated-cell-3-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix home permissions. Not needed in JupyterHub with persistent memory but needed if not used in that context</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="12">12</button><span id="annotated-cell-3-62" class="code-annotation-target"><a href="#annotated-cell-3-62" aria-hidden="true" tabindex="-1"></a>RUN <span class="sc">/</span>pyrocket_scripts<span class="sc">/</span>fix<span class="sc">-</span>home<span class="sc">-</span>permissions.sh</span>
<span id="annotated-cell-3-63"><a href="#annotated-cell-3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-64"><a href="#annotated-cell-3-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the start command </span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="13">13</button><span id="annotated-cell-3-65" class="code-annotation-target"><a href="#annotated-cell-3-65" aria-hidden="true" tabindex="-1"></a>USER <span class="sc">$</span>{NB_USER}</span>
<span id="annotated-cell-3-66"><a href="#annotated-cell-3-66" aria-hidden="true" tabindex="-1"></a>RUN chmod <span class="sc">+</span>x <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>start \</span>
<span id="annotated-cell-3-67"><a href="#annotated-cell-3-67" aria-hidden="true" tabindex="-1"></a>    <span class="sc">&amp;&amp;</span> cp <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>start <span class="sc">/</span>srv<span class="sc">/</span>start</span>
<span id="annotated-cell-3-68"><a href="#annotated-cell-3-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-3-69"><a href="#annotated-cell-3-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Revert to default user and home as pwd</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="14">14</button><span id="annotated-cell-3-70" class="code-annotation-target"><a href="#annotated-cell-3-70" aria-hidden="true" tabindex="-1"></a>USER <span class="sc">$</span>{NB_USER}</span>
<span id="annotated-cell-3-71"><a href="#annotated-cell-3-71" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="sc">$</span>{HOME}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="3" data-code-annotation="1">Some commands need to be run as root, such as installing linux packages with <code>apt-get</code></span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="7,8,9" data-code-annotation="2">Set variables. CONDA_ENV is useful for child builds</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="16,17,18,19" data-code-annotation="3">Copy the py-rocket-base files into <code>/srv/repo</code> directory. <code>book</code> and <code>docs</code> are the documentation files and are not needed in the image.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="22,23,24,25" data-code-annotation="4">Copy the pyrocket scripts into the image and set the permissions so they can be executed by the staff group (which includes jovyan). The <a href="https://github.com/nmfs-opensci/py-rocket-base/tree/main/scripts">pyrocket scripts</a> are used to do most of the installation tasks and these can also be used to extend py-rocket-base.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="28" data-code-annotation="5">Use the pyrocket script to install the conda packages in <code>environment.yml</code>. The script does clean-up. The core package is the pangeo-notebook metapackage to this are added some JupyterLab extensions and packages needed for RStudio and Desktop. Scientific packages are not added here. They will be added via child images that use py-rocket-base as the base image (in the FROM line).</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="31" data-code-annotation="6">This section runs the script <code>install-rocker.sh</code> which installs R and RStudio using rocker scripts.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="35" data-code-annotation="7">The linux packages are installed with the <code>install-apt-packages</code> script which takes care of clean-up. These packages need to be installed after R is installed because the R scripts uninstall packages as part of cleanup.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="38" data-code-annotation="8">The VSCode extensions are installed into the conda environment directory since instead of the home directory since the home directory is replaced by the user persistent home directory in a JupyterHub.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="42,43,44" data-code-annotation="9">Ubuntu does not have man pages installed by default. These lines activate <code>man</code> so users have the common help files.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="47,48,49,50" data-code-annotation="10">This is some custom jupyter config to allow hidden files to be listed in the folder browser.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="53,54,55,56,57,58,59" data-code-annotation="11">Setting up Desktop. Keep config in the <code>/etc</code> so doesn’t trash user environment (that they might want for other environments). Setting up Desktop configuration very poorly documented. The key is setting the environmental variable <code>XDG_CONFIG_HOME</code> and then putting the file <code>user-dirs.dirs</code> within that directory. In that file, one can specify <code>XDG_DESKTOP_DIR="/usr/share/Desktop"</code> which says where application files are kept.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="62" data-code-annotation="12">Ensure that none of the directories in <code>/home</code> are owned by root. When the image is used in a JupyterHub, this won’t matter if home is replaced by the user persistent directory but in other applications having any directories in home owned by root will cause problems.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="65,66,67" data-code-annotation="13">The start file mainly includes a subshell to run any start files used in extenstions from the py-rocket-base image.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="14">14</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="70,71" data-code-annotation="14">The parent docker build completes by setting the user to jovyan and the working directory to <code>${HOME}</code>. Within a JupyterHub deployment, <code>${HOME}</code> will often be re-mapped to the user persistent memory so it is important not to write anything that needs to be persistent to <code>${HOME}</code>, for example configuration. You can do this in the <code>start</code> script since that runs after the user directory is mapped or you can put configuration files in some place other than <code>${HOME}</code>.</span>
</dd>
</dl>
</section>
<section id="install-rocker.sh" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="install-rocker.sh"><span class="header-section-number">9.6</span> install-rocker.sh</h2>
<p>This script will copy in the rocker scripts from <a href="https://github.com/rocker-org/rocker-versioned2">rocker-versioned2</a> into <code>${REPO_DIR}</code> to install things. It will read in one of the rocker docker files using <code>R_DOCKERFILE</code> defined in the <code>appendix</code> file (which is inserted into the main docker file). Variables defined here will only be available in this script. Click on the numbers in the script to learn what each section is doing. This shows the core of the script, but the script also has code that is setting up the R kernel for Jupyter Lab and VSCode and does some more setup to make sure R works well in the Hub.</p>
<div class="sourceCode" id="annotated-cell-4"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>set <span class="sc">-</span>e</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy in the rocker files. Work in ${REPO_DIR} to make sure I don't clobber anything</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-5" class="code-annotation-target"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>cd <span class="sc">$</span>{REPO_DIR}</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>wget https<span class="sc">:</span><span class="er">//</span>github.com<span class="sc">/</span>rocker<span class="sc">-</span>org<span class="sc">/</span>rocker<span class="sc">-</span>versioned2<span class="sc">/</span>archive<span class="sc">/</span>refs<span class="sc">/</span>tags<span class="sc">/</span>R<span class="sc">$</span>{R_VERSION}.tar.gz</span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a>tar zxvf R<span class="sc">$</span>{R_VERSION}.tar.gz <span class="sc">&amp;&amp;</span> \</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2">2</button><span id="annotated-cell-4-8" class="code-annotation-target"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a>mv rocker<span class="sc">-</span>versioned2<span class="sc">-</span>R<span class="sc">$</span>{R_VERSION}<span class="sc">/</span>scripts <span class="sc">/</span>rocker_scripts <span class="sc">&amp;&amp;</span> \</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3">3</button><span id="annotated-cell-4-9" class="code-annotation-target"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>ROCKER_DOCKERFILE_NAME<span class="ot">=</span><span class="st">"${R_DOCKERFILE}.Dockerfile"</span></span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a>mv rocker<span class="sc">-</span>versioned2<span class="sc">-</span>R<span class="sc">$</span>{R_VERSION}<span class="sc">/</span>dockerfiles<span class="sc">/</span><span class="er">$</span>{ROCKER_DOCKERFILE_NAME}  <span class="sc">/</span>rocker_scripts<span class="sc">/</span>original.Dockerfile <span class="sc">&amp;&amp;</span> \</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4">4</button><span id="annotated-cell-4-11" class="code-annotation-target"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a>rm R<span class="sc">$</span>{R_VERSION}.tar.gz <span class="sc">&amp;&amp;</span> \</span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a>rm <span class="sc">-</span>rf rocker<span class="sc">-</span>versioned2<span class="sc">-</span>R<span class="sc">$</span>{R_VERSION}</span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="5">5</button><span id="annotated-cell-4-14" class="code-annotation-target"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a>cd <span class="sc">/</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="6">6</button><span id="annotated-cell-4-15" class="code-annotation-target"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the Dockerfile and process each line</span></span>
<span id="annotated-cell-4-16"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> IFS<span class="ot">=</span> read <span class="sc">-</span>r line; do</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="7">7</button><span id="annotated-cell-4-17" class="code-annotation-target"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the line starts with ENV or RUN</span></span>
<span id="annotated-cell-4-18"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> [[ <span class="st">"$line"</span> <span class="sc">==</span> ENV<span class="sc">*</span> ]]; then</span>
<span id="annotated-cell-4-19"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign variable</span></span>
<span id="annotated-cell-4-20"><a href="#annotated-cell-4-20" aria-hidden="true" tabindex="-1"></a>        var_assignment<span class="ot">=</span><span class="er">$</span>(echo <span class="st">"$line"</span> <span class="sc">|</span> sed <span class="st">'s/^ENV //g'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="8">8</button><span id="annotated-cell-4-21" class="code-annotation-target"><a href="#annotated-cell-4-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Replace ENV DEFAULT_USER="jovyan"</span></span>
<span id="annotated-cell-4-22"><a href="#annotated-cell-4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> [[ <span class="st">"$var_assignment"</span> <span class="sc">==</span> DEFAULT_USER<span class="sc">*</span> ]]; then</span>
<span id="annotated-cell-4-23"><a href="#annotated-cell-4-23" aria-hidden="true" tabindex="-1"></a>            var_assignment<span class="ot">=</span><span class="st">"DEFAULT_USER=${NB_USER}"</span></span>
<span id="annotated-cell-4-24"><a href="#annotated-cell-4-24" aria-hidden="true" tabindex="-1"></a>        fi</span>
<span id="annotated-cell-4-25"><a href="#annotated-cell-4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run this way eval "export ..." otherwise the " will get turned to %22</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="9">9</button><span id="annotated-cell-4-26" class="code-annotation-target"><a href="#annotated-cell-4-26" aria-hidden="true" tabindex="-1"></a>        eval <span class="st">"export $var_assignment"</span></span>
<span id="annotated-cell-4-27"><a href="#annotated-cell-4-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Write the exported variable to env.txt</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="10">10</button><span id="annotated-cell-4-28" class="code-annotation-target"><a href="#annotated-cell-4-28" aria-hidden="true" tabindex="-1"></a>        echo <span class="st">"export $var_assignment"</span> <span class="sc">&gt;</span><span class="er">&gt;</span> <span class="er">$</span>{REPO_DIR}<span class="sc">/</span>env.txt</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="11">11</button><span id="annotated-cell-4-29" class="code-annotation-target"><a href="#annotated-cell-4-29" aria-hidden="true" tabindex="-1"></a>    elif [[ <span class="st">"$line"</span> <span class="sc">==</span> RUN<span class="sc">*</span> ]]; then</span>
<span id="annotated-cell-4-30"><a href="#annotated-cell-4-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run the command from the RUN line</span></span>
<span id="annotated-cell-4-31"><a href="#annotated-cell-4-31" aria-hidden="true" tabindex="-1"></a>        cmd<span class="ot">=</span><span class="er">$</span>(echo <span class="st">"$line"</span> <span class="sc">|</span> sed <span class="st">'s/^RUN //g'</span>)</span>
<span id="annotated-cell-4-32"><a href="#annotated-cell-4-32" aria-hidden="true" tabindex="-1"></a>        echo <span class="st">"Executing: $cmd"</span></span>
<span id="annotated-cell-4-33"><a href="#annotated-cell-4-33" aria-hidden="true" tabindex="-1"></a>        eval <span class="st">"$cmd"</span> <span class="co"># || echo ${cmd}" encountered an error, but continuing..."</span></span>
<span id="annotated-cell-4-34"><a href="#annotated-cell-4-34" aria-hidden="true" tabindex="-1"></a>    fi</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="12">12</button><span id="annotated-cell-4-35" class="code-annotation-target"><a href="#annotated-cell-4-35" aria-hidden="true" tabindex="-1"></a>done <span class="sc">&lt;</span> <span class="er">/</span>rocker_scripts<span class="sc">/</span>original.Dockerfile</span>
<span id="annotated-cell-4-36"><a href="#annotated-cell-4-36" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="13">13</button><span id="annotated-cell-4-37" class="code-annotation-target"><a href="#annotated-cell-4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extra tex packages that are not installed by default</span></span>
<span id="annotated-cell-4-38"><a href="#annotated-cell-4-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> command <span class="sc">-</span>v tlmgr <span class="sc">&amp;</span><span class="er">&gt;</span> <span class="er">/</span>dev<span class="sc">/</span>null; then</span>
<span id="annotated-cell-4-39"><a href="#annotated-cell-4-39" aria-hidden="true" tabindex="-1"></a>    echo <span class="st">"Installing texlive collection-latexrecommended..."</span></span>
<span id="annotated-cell-4-40"><a href="#annotated-cell-4-40" aria-hidden="true" tabindex="-1"></a>    tlmgr install collection<span class="sc">-</span>latexrecommended</span>
<span id="annotated-cell-4-41"><a href="#annotated-cell-4-41" aria-hidden="true" tabindex="-1"></a>    tlmgr install pdfcol tcolorbox eurosym upquote adjustbox titling enumitem ulem soul rsfs</span>
<span id="annotated-cell-4-42"><a href="#annotated-cell-4-42" aria-hidden="true" tabindex="-1"></a>fi</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="5,6,7" data-code-annotation="1">The <a href="https://github.com/rocker-org/rocker-versioned2">rocker-versioned2</a> repository for a particular R version is copied into <code>{REPO_DIR}</code> and unzipped. <code>R_VERSION</code> is defined in <code>appendix</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="8" data-code-annotation="2">The unzipped directory will be named <code>rocker-versioned2-R${R_VERSION}</code>. We move the <code>scripts</code> directory to <code>/rocker_scripts</code> (base level) because the rocker scripts expect the scripts to be there.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="9,10" data-code-annotation="3"><code>R_DOCKERFILE</code> is defined as <code>verse_${R_VERSION}</code>. The docker file we will process (find ENV and RUN lines) is called <code>ROCKER_DOCKERFILE_NAME</code> in the rocker files. We move this to <code>/rocker_scripts/original.Dockerfile</code> so we can refer to it later.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="11,12" data-code-annotation="4">Clean up the rocker directories that we no longer need.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="14" data-code-annotation="5">cd to the base level where <code>/rocker_scripts</code> is.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="15,16" data-code-annotation="6">The big while loop is processing <code>/rocker_scripts/original.Dockerfile</code>. The code is using piping <code>&gt;</code> and the input file and pipe is specified at the end of the while loop code.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="17,18,19,20" data-code-annotation="7">This looks if the line starts with <code>ENV</code> and if it does, it strips off <code>ENV</code> and stores the variable assigment statement to <code>$var_assignment</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="21,22,23,24" data-code-annotation="8">The rocker docker files do not use the <code>NB_USER</code> environmental variable (defined in <code>appendix</code>). If the <code>ENV</code> line is defining the default user, we need to change that assignment to the variable <code>NB_USER</code>. This part is specific to the rocker docker files.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="26" data-code-annotation="9">We need to export any variables (<code>ENV</code>) found in the docker file so it is available to the scripts that will run in the <code>RUN</code> statements. We need to export the variables as done here (with <code>eval</code> and <code>export</code>) otherwise they don’t make it to the child scripts about to be run. Getting variables to be exported to child scripts being called by a parent script is tricky and this line required a lot of testing and debugging to get variables exported properly.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="28" data-code-annotation="10">The export line will only make the variable available to the child scripts. We also want them available in the final image. To do that, we write them to a file that we will source from the docker file. Scripts are run in an ephemeral subshell during docker builds so we cannot define the variable here.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="29,30,31,32,33,34" data-code-annotation="11">If the docker file line starts with <code>RUN</code> then run the command. This command should be a rocker script because that is how rocker docker files are organized. See an example <a href="https://github.com/rocker-org/rocker-versioned2/blob/master/dockerfiles/verse_4.4.1.Dockerfile">rocker docker file</a>.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="35" data-code-annotation="12">Here the input file for the while loop is specified.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="37,38,39,40,41,42" data-code-annotation="13">The rocker <code>install_texlive.sh</code> script (which is part of verse) will provide a basic texlive installation. Here a few more packages are added so that the user is able to run vanilla Quarto to PDF and Myst to PDF. See the <a href="tex.html">chapter on texlive</a>.</span>
</dd>
</dl>
</section>
<section id="start" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="start"><span class="header-section-number">9.7</span> start</h2>
<p>Within a JupyterHub, the user home directory <code>$HOME</code> is typically re-mapped to the user persistent home directory. That means that the image build process cannot put things into <code>$HOME</code>, they would just be lost when <code>$HOME</code> is re-mapped. If a process needs to have something in the home directory, e.g.&nbsp;in some local user configuration, this must be done in the <code>start</code> script. The repo2docker docker image specifies that the start script is <code>${REPO_DIR}/start</code>. In py-rocket-base, the start scripts in a child docker file is souces in a subshell from the py-rocket-base start script.</p>
<div class="sourceCode" id="annotated-cell-5"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>set <span class="sc">-</span>euo pipefail</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Start - Set any environment variables here</span></span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># These are inherited by all processes, *except* RStudio</span></span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># USE export &lt;parname&gt;=value</span></span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># source this file to get the variables defined in the rocker Dockerfile</span></span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a>source <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>env.txt</span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># End - Set any environment variables here</span></span>
<span id="annotated-cell-5-10"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run child start scripts in a subshell to contain its environment</span></span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ${REPO_DIR}/childstart/ is created by setup-start.sh</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2">2</button><span id="annotated-cell-5-13" class="code-annotation-target"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="sc">-</span>d <span class="st">"${REPO_DIR}/childstart/"</span> ]; then</span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> script <span class="cf">in</span> <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>childstart<span class="sc">/</span><span class="er">*</span>; do</span>
<span id="annotated-cell-5-15"><a href="#annotated-cell-5-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> [ <span class="sc">-</span>f <span class="st">"$script"</span> ]; then</span>
<span id="annotated-cell-5-16"><a href="#annotated-cell-5-16" aria-hidden="true" tabindex="-1"></a>            echo <span class="st">"Sourcing script: $script"</span></span>
<span id="annotated-cell-5-17"><a href="#annotated-cell-5-17" aria-hidden="true" tabindex="-1"></a>            source <span class="st">"$script"</span> <span class="sc">||</span> {</span>
<span id="annotated-cell-5-18"><a href="#annotated-cell-5-18" aria-hidden="true" tabindex="-1"></a>                echo <span class="st">"Error: Failed to source $script. Moving on to the next script."</span></span>
<span id="annotated-cell-5-19"><a href="#annotated-cell-5-19" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="annotated-cell-5-20"><a href="#annotated-cell-5-20" aria-hidden="true" tabindex="-1"></a>        fi</span>
<span id="annotated-cell-5-21"><a href="#annotated-cell-5-21" aria-hidden="true" tabindex="-1"></a>    done</span>
<span id="annotated-cell-5-22"><a href="#annotated-cell-5-22" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="annotated-cell-5-23"><a href="#annotated-cell-5-23" aria-hidden="true" tabindex="-1"></a>exec <span class="st">"$@"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4,5,6,7,8,9" data-code-annotation="1">In a Docker file so no way to dynamically set environmental variables, so the <code>env.txt</code> file with the <code>export &lt;var&gt;=&lt;value&gt;</code> are source at start up.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="13,14,15,16,17,18,19,20,21,22" data-code-annotation="2">Run any child start script in a subshell. Run in a subshell to contain any <code>set</code> statements or similar. start scripts are moved into <code>childstarts</code> by the <code>setup-start.sh</code> pyrocket script.</span>
</dd>
</dl>
</section>
<section id="setup-desktop.sh" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="setup-desktop.sh"><span class="header-section-number">9.8</span> setup-desktop.sh</h2>
<p>The default for XDG and xfce4 is for Desktop files to be in <code>~/Desktop</code> but this leads to a variety of problems. First we are altering the user directiory which seems rude, second orphan desktop files might be in <code>~/Desktop</code> so who knows what the user Desktop experience with be, here the Desktop dir is set to <code>/usr/share/Desktop</code> so is part of the image. Users that really want to customize Desktop can change <code>~/.config/user-dirs.dirs</code>. Though py-rocket-base might not respect that. Not sure why you’d do that instead of just using a different image that doesn’t have the py-rocket-base behavior.</p>
<div class="sourceCode" id="annotated-cell-6"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>set <span class="sc">-</span>e</span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy in the Desktop files</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-5" class="code-annotation-target"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>APPLICATIONS_DIR<span class="ot">=</span><span class="er">/</span>usr<span class="sc">/</span>share<span class="sc">/</span>applications</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2">2</button><span id="annotated-cell-6-6" class="code-annotation-target"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>DESKTOP_DIR<span class="ot">=</span><span class="er">/</span>usr<span class="sc">/</span>share<span class="sc">/</span>Desktop</span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>mkdir <span class="sc">-</span>p <span class="st">"${DESKTOP_DIR}"</span></span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>chown <span class="sc">:</span>staff <span class="sc">/</span>usr<span class="sc">/</span>share<span class="sc">/</span>Desktop</span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>chmod <span class="dv">775</span> <span class="sc">/</span>usr<span class="sc">/</span>share<span class="sc">/</span>Desktop</span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set the Desktop dir default for XDG</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3">3</button><span id="annotated-cell-6-11" class="code-annotation-target"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a>echo <span class="st">'XDG_DESKTOP_DIR="${DESKTOP_DIR}"'</span> <span class="sc">&gt;</span> <span class="er">/</span>etc<span class="sc">/</span>xdg<span class="sc">/</span>user<span class="sc">-</span>dirs.defaults</span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># The for loops will fail if they return null (no files). Set shell option nullglob</span></span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>shopt <span class="sc">-</span>s nullglob</span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4">4</button><span id="annotated-cell-6-16" class="code-annotation-target"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> desktop_file_path <span class="cf">in</span> <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>Desktop<span class="sc">/</span><span class="er">*</span>.desktop; do</span>
<span id="annotated-cell-6-17"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">"${desktop_file_path}"</span> <span class="st">"${APPLICATIONS_DIR}/."</span></span>
<span id="annotated-cell-6-18"><a href="#annotated-cell-6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Symlink application to desktop and set execute permission so xfce (desktop) doesn't complain</span></span>
<span id="annotated-cell-6-19"><a href="#annotated-cell-6-19" aria-hidden="true" tabindex="-1"></a>    desktop_file_name<span class="ot">=</span><span class="st">"$(basename ${desktop_file_path})"</span></span>
<span id="annotated-cell-6-20"><a href="#annotated-cell-6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set execute permissions on the copied .desktop file</span></span>
<span id="annotated-cell-6-21"><a href="#annotated-cell-6-21" aria-hidden="true" tabindex="-1"></a>    chmod <span class="sc">+</span>x <span class="st">"${APPLICATIONS_DIR}/${desktop_file_name}"</span></span>
<span id="annotated-cell-6-22"><a href="#annotated-cell-6-22" aria-hidden="true" tabindex="-1"></a>    ln <span class="sc">-</span>sf <span class="st">"${APPLICATIONS_DIR}/${desktop_file_name}"</span> <span class="st">"${DESKTOP_DIR}/${desktop_file_name}"</span></span>
<span id="annotated-cell-6-23"><a href="#annotated-cell-6-23" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="annotated-cell-6-24"><a href="#annotated-cell-6-24" aria-hidden="true" tabindex="-1"></a>update<span class="sc">-</span>desktop<span class="sc">-</span>database <span class="st">"${APPLICATIONS_DIR}"</span></span>
<span id="annotated-cell-6-25"><a href="#annotated-cell-6-25" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="5">5</button><span id="annotated-cell-6-26" class="code-annotation-target"><a href="#annotated-cell-6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add MIME Type data from XML files  to the MIME database.</span></span>
<span id="annotated-cell-6-27"><a href="#annotated-cell-6-27" aria-hidden="true" tabindex="-1"></a>MIME_DIR<span class="ot">=</span><span class="st">"/usr/share/mime"</span></span>
<span id="annotated-cell-6-28"><a href="#annotated-cell-6-28" aria-hidden="true" tabindex="-1"></a>MIME_PACKAGES_DIR<span class="ot">=</span><span class="st">"${MIME_DIR}/packages"</span></span>
<span id="annotated-cell-6-29"><a href="#annotated-cell-6-29" aria-hidden="true" tabindex="-1"></a>mkdir <span class="sc">-</span>p <span class="st">"${MIME_PACKAGES_DIR}"</span></span>
<span id="annotated-cell-6-30"><a href="#annotated-cell-6-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mime_file_path <span class="cf">in</span> <span class="sc">$</span>{REPO_DIR}<span class="sc">/</span>Desktop<span class="sc">/</span><span class="er">*</span>.xml; do</span>
<span id="annotated-cell-6-31"><a href="#annotated-cell-6-31" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">"${mime_file_path}"</span> <span class="st">"${MIME_PACKAGES_DIR}/."</span></span>
<span id="annotated-cell-6-32"><a href="#annotated-cell-6-32" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="annotated-cell-6-33"><a href="#annotated-cell-6-33" aria-hidden="true" tabindex="-1"></a>update<span class="sc">-</span>mime<span class="sc">-</span>database <span class="st">"${MIME_DIR}"</span></span>
<span id="annotated-cell-6-34"><a href="#annotated-cell-6-34" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="6">6</button><span id="annotated-cell-6-35" class="code-annotation-target"><a href="#annotated-cell-6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Add icons</span></span>
<span id="annotated-cell-6-36"><a href="#annotated-cell-6-36" aria-hidden="true" tabindex="-1"></a>ICON_DIR<span class="ot">=</span><span class="st">"/usr/share/icons"</span></span>
<span id="annotated-cell-6-37"><a href="#annotated-cell-6-37" aria-hidden="true" tabindex="-1"></a>ICON_PACKAGES_DIR<span class="ot">=</span><span class="st">"${ICON_DIR}/packages"</span></span>
<span id="annotated-cell-6-38"><a href="#annotated-cell-6-38" aria-hidden="true" tabindex="-1"></a>mkdir <span class="sc">-</span>p <span class="st">"${ICON_PACKAGES_DIR}"</span></span>
<span id="annotated-cell-6-39"><a href="#annotated-cell-6-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> icon_file_path <span class="cf">in</span> <span class="st">"${REPO_DIR}"</span><span class="sc">/</span>Desktop<span class="sc">/</span><span class="er">*</span>.png; do</span>
<span id="annotated-cell-6-40"><a href="#annotated-cell-6-40" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">"${icon_file_path}"</span> <span class="st">"${ICON_PACKAGES_DIR}/"</span> <span class="sc">||</span> echo <span class="st">"Failed to copy ${icon_file_path}"</span></span>
<span id="annotated-cell-6-41"><a href="#annotated-cell-6-41" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="annotated-cell-6-42"><a href="#annotated-cell-6-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> icon_file_path <span class="cf">in</span> <span class="st">"${REPO_DIR}"</span><span class="sc">/</span>Desktop<span class="sc">/</span><span class="er">*</span>.svg; do</span>
<span id="annotated-cell-6-43"><a href="#annotated-cell-6-43" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">"${icon_file_path}"</span> <span class="st">"${ICON_PACKAGES_DIR}/"</span> <span class="sc">||</span> echo <span class="st">"Failed to copy ${icon_file_path}"</span></span>
<span id="annotated-cell-6-44"><a href="#annotated-cell-6-44" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="annotated-cell-6-45"><a href="#annotated-cell-6-45" aria-hidden="true" tabindex="-1"></a>gtk<span class="sc">-</span>update<span class="sc">-</span>icon<span class="sc">-</span>cache <span class="st">"${ICON_DIR}"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="5" data-code-annotation="1">This is the default local for system applications.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="6,7,8,9" data-code-annotation="2">Create the Desktop directory and make sure jovyan can put files there. This is mainly for debugging.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="11" data-code-annotation="3">This is not needed. It is the <code>user-dirs.dirs</code> file that is used.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="16,17,18,19,20,21,22,23,24" data-code-annotation="4">Copy the .desktop file in the Desktop directory into the applications directory and make a symlink to the Desktop directory. The former means that the applications will appear in the menu in xfce4 desktop and the latter means there will be a desktop icon.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="26,27,28,29,30,31,32,33" data-code-annotation="5">Add any mime xml files to the mime folder and update the mime database.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="35,36,37,38,39,40,41,42,43,44,45" data-code-annotation="6">Add any png or svg icon files to the icon folder and update the icon database.</span>
</dd>
</dl>
</section>
<section id="notes-on-the-jupyter-lab-environment" class="level2" data-number="9.9">
<h2 data-number="9.9" class="anchored" data-anchor-id="notes-on-the-jupyter-lab-environment"><span class="header-section-number">9.9</span> Notes on the Jupyter Lab environment</h2>
<section id="terminal-in-jupyter-lab" class="level3" data-number="9.9.1">
<h3 data-number="9.9.1" class="anchored" data-anchor-id="terminal-in-jupyter-lab"><span class="header-section-number">9.9.1</span> Terminal in Jupyter Lab</h3>
<p>When a terminal is launched from the Launcher, it starts a login bash shell (<code>bash -l</code>). When login bash shells are started, <code>/etc/profile</code> script is run. For this image, this script will execute all the scripts in the directory <code>/etc/profile.d</code>. There is the script <code>init_conda.sh</code> which ensures that the conda notebook environment is activated. The user might override this if they create <code>~/.bashrc_profile</code> in which case that is used instead of <code>/etc/profile</code>.</p>
<p>For non-login bash shells (interactive), <code>/etc/bash.bashrc</code> determines the shell environment unless the user has created <code>~/.bashrc</code>, in which case that file determines the shell environment. In Jupyter Lab, you can start and interactive shell by running <code>bash</code> (from a terminal). Be aware that if you run <code>bash</code> it might look like the conda environment is deactivated but it is really not since the <code>PATH</code> still includes <code>conda</code> in it. If you are trying to get remove <code>conda</code> from the path (and get rid of all the conda environment variables) you need to run <code>conda deactivate</code> (2x).</p>
</section>
</section>
<section id="notes-on-r-in-the-rstudio-or-jupyter-lab-environment" class="level2" data-number="9.10">
<h2 data-number="9.10" class="anchored" data-anchor-id="notes-on-r-in-the-rstudio-or-jupyter-lab-environment"><span class="header-section-number">9.10</span> Notes on R in the RStudio or Jupyter Lab environment</h2>
<p><a href="https://github.com/jupyterhub/jupyter-rsession-proxy">jupyter-rsession-proxy</a> in <code>environment.yml</code> allows us to launch RStudio from Jupyter Lab and <code>IRkernel</code> run in our R installation via this in the Docker file</p>
<pre><code>RUN Rscript -e "install.packages('IRkernel')" &amp;&amp; \
    PATH=/srv/conda/envs/notebook/bin:$PATH Rscript -e "IRkernel::installspec(name = 'ir', displayname = 'R ${R_VERSION}')"</code></pre>
<p>creates a Jupyter Lab kernel called <code>R X.X.X</code> using our R installation (in <code>/usr/local/bin/R</code>) with all our libraries.</p>
<p>However we enter the R environment (either in Jupyter Lab or RStudio), the environment is different than the default environment if you use the default Python environment (the conda ‘notebook’ environment).</p>
<section id="environmental-variables" class="level3" data-number="9.10.1">
<h3 data-number="9.10.1" class="anchored" data-anchor-id="environmental-variables"><span class="header-section-number">9.10.1</span> Environmental variables</h3>
<ul>
<li>PATH is different. conda is not on the path. Try <code>Sys.getenv("PATH")</code>. This is on purpose because the R geospatial packages get confused if one uses the GDAL associated with the conda environment. This is critical to know if you are using <code>reticulate</code> and <code>Python</code> inside of R. conda will not be on the path and all the Python libraries will not be accessible. If you want to use the conda environment, you have to run this. The first line tells R where the conda binary is because it has no way to find it since conda is not on its system PATH.</li>
</ul>
<pre><code>options(reticulate.conda_binary = "/srv/conda/condabin/conda")
reticulate::use_condaenv("/srv/conda/envs/notebook", required = TRUE)</code></pre>
<ul>
<li><strong>For RStudio only</strong>: None of the environmental variables in the docker file will be in the <code>/rstudio</code> environment. The start command affects <code>\lab</code> and <code>\notebook</code> but not <code>\rstudio</code>. I have made some attempt to add back in a few required ones in <code>/usr/local/lib/R/etc/Rprofile.site</code> but it is very minimal.</li>
</ul>
<p>If your users need some environmental variable set, they will need to set those in <code>$R_HOME/etc/Rprofile.site</code> which is run when R starts.</p>
</section>
<section id="terminal-in-rstudio" class="level3" data-number="9.10.2">
<h3 data-number="9.10.2" class="anchored" data-anchor-id="terminal-in-rstudio"><span class="header-section-number">9.10.2</span> Terminal in RStudio</h3>
<p>The default way that a terminal is started in RStudio is <code>bash -l</code> which means it is a login terminal. When a login terminal launches, <code>/etc/profile</code> script is run. For this image, this script will execute all the scripts in the directory <code>/etc/profile.d</code>. You can add scripts there that you want to run when a login terminal is started. In particular, there is the script <code>init_conda.sh</code>. This ensures that when a terminal is opened from the Launcher in JupyterLab, the conda notebook environment is activated. However, we do not want this to happen in RStudio so the script checks if RSTUDIO==1 and R_HOME is set, if that is true then we are in the RStudio UI and conda should not be initialized (and is not).</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nmfs-opensci\.github\.io\/py-rocket-base");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./r-config.html" class="pagination-link" aria-label="R in Jupyter Lab and Python in RStudio">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">R in Jupyter Lab and Python in RStudio</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./related.html" class="pagination-link" aria-label="Related Docker Stacks">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Related Docker Stacks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nmfs-opensci/py-rocket-base/edit/main/developers.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nmfs-opensci/py-rocket-base/blob/main/developers.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/nmfs-opensci/py-rocket-base/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>