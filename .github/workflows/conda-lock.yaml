name: update conda lockfile
on:
  workflow_dispatch:
  push:
    branches: [test]
    paths:
      - 'apt.txt'
      - 'user-dirs.dirs'
      - 'vscode-extensions.txt'
      - 'environment.yml'
      - 'start'
      - 'postBuild'
      - 'Dockerfile'
      - 'custom_jupyter_server_config.json'
      - 'scripts/**'
      - '.github/workflows/build.yaml'
      - '.github/workflows/conda-lock.yaml'
      - '!book/**'
      - '!docs/**'
      - '!base-image/**'
      - '!README.md'
      - '!NOTES.md'
      - '!.gitignore'
      - '!conda-lock.yml'
      - '!LICENSE'
  
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v4
      with:
        ref: test
    - name: install conda-lock with micromamba
      uses: mamba-org/setup-micromamba@main
      with:
        environment-name: locker
        create-args: conda-lock
        cache-environment: true
    - name: run conda-lock
      shell: bash -el {0}
      run: |
        conda-lock lock --mamba --file environment.yml --platform linux-64
    - name: commit changes to tracked files
      run: |
        if [[ $(git ls-files --modified) ]]; then
          git config --global user.name 'actions-bot'
          git config --global user.email '58130806+actions-bot@users.noreply.github.com'
          git commit --all --message "[bot] autogenerated conda-lock files"
          git push
        fi
